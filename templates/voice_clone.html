<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <title data-i18n="voice.title">音色注册网页 - Project N.E.K.O.</title>
    <!-- i18next 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/dist/umd/i18next.min.js" 
            onerror="console.error('[i18n] 加载 i18next 失败');"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"
            onerror="console.error('[i18n] 加载 i18nextBrowserLanguageDetector 失败');"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/dist/umd/i18nextHttpBackend.min.js"
            onerror="console.error('[i18n] 加载 i18nextHttpBackend 失败');"></script>
    <!-- i18next 初始化脚本（包含诊断工具） -->
    <script>
        // 等待所有脚本加载完成后再执行初始化
        (function() {
            let checkCount = 0;
            const maxChecks = 50; // 最多检查 5 秒
            
            function checkDependencies() {
                checkCount++;
                
                const i18nextLoaded = typeof i18next !== 'undefined';
                const detectorLoaded = typeof i18nextBrowserLanguageDetector !== 'undefined';
                const backendLoaded = typeof i18nextHttpBackend !== 'undefined';
                
                if (i18nextLoaded && detectorLoaded && backendLoaded) {
                    console.log('[i18n] ✅ 所有依赖库已加载');
                    // 加载初始化脚本
                    const script = document.createElement('script');
                    script.src = '/static/i18n-i18next.js';
                    document.head.appendChild(script);
                } else if (checkCount < maxChecks) {
                    // 继续等待
                    setTimeout(checkDependencies, 100);
                } else {
                    // 超时，尝试使用备用 CDN
                    console.error('[i18n] ⚠️ 依赖库加载超时，尝试使用备用 CDN...');
                    console.log('[i18n] 加载状态:', {
                        i18next: i18nextLoaded,
                        detector: detectorLoaded,
                        backend: backendLoaded
                    });
                    
                    // 如果 i18nextHttpBackend 未加载，尝试备用 CDN
                    if (!backendLoaded) {
                        console.log('[i18n] 尝试从 unpkg CDN 加载 i18nextHttpBackend...');
                        const backupScript = document.createElement('script');
                        backupScript.src = 'https://unpkg.com/i18next-http-backend@2.4.2/dist/umd/i18nextHttpBackend.min.js';
                        backupScript.onload = function() {
                            console.log('[i18n] ✅ 备用 CDN 加载成功');
                            // 再次检查并加载初始化脚本
                            setTimeout(() => {
                                if (typeof i18nextHttpBackend !== 'undefined') {
                                    const script = document.createElement('script');
                                    script.src = '/static/i18n-i18next.js';
                                    document.head.appendChild(script);
                                }
                            }, 100);
                        };
                        backupScript.onerror = function() {
                            console.error('[i18n] ❌ 备用 CDN 也加载失败');
                            // 即使失败也加载初始化脚本，让它使用降级方案
                            const script = document.createElement('script');
                            script.src = '/static/i18n-i18next.js';
                            document.head.appendChild(script);
                        };
                        document.head.appendChild(backupScript);
                    } else {
                        // 其他库未加载，直接加载初始化脚本
                        console.log('[i18n] 加载初始化脚本（使用降级方案）');
                        const script = document.createElement('script');
                        script.src = '/static/i18n-i18next.js';
                        document.head.appendChild(script);
                    }
                }
            }
            
            // 开始检查
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkDependencies);
            } else {
                checkDependencies();
            }
            
            // 安全网：10秒后强制加载初始化脚本（即使依赖未加载）
            setTimeout(function() {
                if (typeof window.setLocale === 'undefined') {
                    console.warn('[i18n] ⚠️ 10秒后仍未初始化，强制加载初始化脚本');
                    const script = document.createElement('script');
                    script.src = '/static/i18n-i18next.js';
                    document.head.appendChild(script);
                }
            }, 10000);
        })();
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .container { max-width: 500px; margin: auto; }
        label { display: block; margin-top: 20px; }
        input[type="text"] { width: 100%; padding: 8px; margin-top: 5px; }
        button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
        .result { margin-top: 30px; font-size: 18px; color: green; }
        .error { color: red; }
        .file-input-wrapper { position: relative; margin-top: 5px; }
        .file-input-wrapper input[type="file"] { position: absolute; opacity: 0; width: 0; height: 0; }
        .file-input-label { display: inline-block; padding: 8px 16px; background: #4f8cff; color: white; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .file-input-label:hover { background: #2662c8; }
        .file-name-display { margin-left: 10px; color: #666; font-size: 14px; }
    </style>
</head>
<body>
<div class="container">
    <h2 data-i18n="voice.title">音色注册</h2>
    <label data-i18n="voice.selectFile">选择本地音频文件（15~20秒最佳，请勿超过45秒，wav/mp3格式）</label>
    <div class="file-input-wrapper">
        <input type="file" id="audioFile" accept="audio/*">
        <label for="audioFile" class="file-input-label" id="fileInputLabel" data-i18n="voice.chooseFile">选择文件</label>
        <span class="file-name-display" id="fileNameDisplay" data-i18n="voice.noFileSelected">未选择文件</span>
    </div>

    <label data-i18n="voice.customPrefix">自定义前缀（阿里云需要）</label>
    <input type="text" id="prefix" data-i18n-placeholder="voice.prefixPlaceholder" placeholder="不超过10个字符，只支持数字和英文字母">

    <input type="hidden" id="lanlan_name" value="">

    <button onclick="registerVoice()" data-i18n="voice.register">注册音色</button>

    <div class="result" id="result"></div>
</div>
<script>
    // 更新文件选择显示
    function updateFileDisplay() {
        const fileInput = document.getElementById('audioFile');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        if (fileInput.files.length > 0) {
            fileNameDisplay.textContent = fileInput.files[0].name;
        } else {
            fileNameDisplay.textContent = window.t ? window.t('voice.noFileSelected') : '未选择文件';
        }
    }
    
    // 监听文件选择变化
    document.getElementById('audioFile').addEventListener('change', updateFileDisplay);
    
    // 页面加载时更新文件选择显示
    // 等待 i18next 初始化完成后再更新
    window.addEventListener('localechange', updateFileDisplay);
    // 如果 i18next 已经初始化完成，立即更新
    if (window.i18n && window.i18n.isInitialized) {
        updateFileDisplay();
    } else {
        // 延迟更新，等待 i18next 初始化
        setTimeout(updateFileDisplay, 500);
    }
    
    // 页面加载时获取 lanlan_name
    (async function initLanlanName() {
        try {
            // 优先从 URL 获取 lanlan_name
            const urlParams = new URLSearchParams(window.location.search);
            let lanlanName = urlParams.get('lanlan_name') || "";
            
            // 如果 URL 中没有，从 API 获取
            if (!lanlanName) {
                const response = await fetch('/api/config/page_config');
                const data = await response.json();
                if (data.success) {
                    lanlanName = data.lanlan_name || "";
                }
            }
            
            // 设置到隐藏字段
            document.getElementById('lanlan_name').value = lanlanName;
            console.log('lanlan_name 已设置:', lanlanName);
        } catch (error) {
            console.error('获取 lanlan_name 失败:', error);
            document.getElementById('lanlan_name').value = "";
        }
    })();

    function setFormDisabled(disabled) {
        document.getElementById('audioFile').disabled = disabled;
        document.getElementById('prefix').disabled = disabled;
        // 禁用所有按钮
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = disabled);
    }

    function registerVoice() {
        const fileInput = document.getElementById('audioFile');
        const prefix = document.getElementById('prefix').value.trim();
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
        resultDiv.className = 'result';
        if (!fileInput.files.length || !prefix) {
            resultDiv.innerHTML = window.t ? window.t('voice.pleaseUploadFile') : '请上传音频文件并填写前缀';
            resultDiv.className = 'result error';
            return;
        }
        setFormDisabled(true);
        resultDiv.innerHTML = window.t ? window.t('voice.registering') : '正在注册声音，请稍后！';
        resultDiv.className = 'result';
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('prefix', prefix);
        fetch('/api/voice_clone', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.voice_id) {
                resultDiv.innerHTML = window.t ? window.t('voice.registerSuccess', {voiceId: data.voice_id}) : '注册成功！voice_id: ' + data.voice_id;
                // 自动更新voice_id到后端
                const lanlanName = document.getElementById('lanlan_name').value;
                if (lanlanName) {
                    fetch(`/api/characters/catgirl/voice_id/${encodeURIComponent(lanlanName)}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ voice_id: data.voice_id })
                    }).then(resp => resp.json()).then(res => {
                        if (!res.success) {
                            const errorMsg = res.error || (window.t ? window.t('common.error') : '未知错误');
                            resultDiv.innerHTML += '<br><span class="error">' + (window.t ? window.t('voice.voiceIdSaveFailed', {error: errorMsg}) : 'voice_id自动保存失败: ' + errorMsg) + '</span>';
                        } else {
                            resultDiv.innerHTML += '<br>' + (window.t ? window.t('voice.voiceIdSaved') : 'voice_id已自动保存到角色');
                            // 如果session被结束，页面会自动刷新
                            if (res.session_restarted) {
                                resultDiv.innerHTML += '<br><span style="color: blue;">' + (window.t ? window.t('voice.pageWillRefresh') : '当前页面即将自动刷新以应用新语音') + '</span>';
                            } else {
                                resultDiv.innerHTML += '<br><span style="color: blue;">' + (window.t ? window.t('voice.voiceWillTakeEffect') : '新语音将在下次对话时生效') + '</span>';
                            }
                            // 通知父页面voice_id已更新
                            if (window.parent !== window) {
                                window.parent.postMessage({type: 'voice_id_updated', voice_id: data.voice_id, session_restarted: res.session_restarted}, '*');
                            }
                        }
                    }).catch(e => {
                        resultDiv.innerHTML += '<br><span class="error">' + (window.t ? window.t('voice.voiceIdSaveRequestError') : 'voice_id自动保存请求出错') + '</span>';
                    });
                }
            } else {
                const errorMsg = data.error || (window.t ? window.t('common.error') : '未知错误');
                resultDiv.innerHTML = window.t ? window.t('voice.registerFailed', {error: errorMsg}) : '注册失败：' + errorMsg;
                resultDiv.className = 'result error';
            }
            setFormDisabled(false);
        })
        .catch(err => {
            const errorMsg = err?.message || err?.toString() || (window.t ? window.t('common.error') : '未知错误');
            resultDiv.textContent = window.t ? window.t('voice.requestError', {error: errorMsg}) : '请求出错：' + errorMsg;
            resultDiv.className = 'result error';
            setFormDisabled(false);
        });
    }

    // 监听API Key变更事件
    window.addEventListener('message', function(event) {
        if (event.data.type === 'api_key_changed') {
            // API Key已更改，可以在这里添加其他需要的处理逻辑
            console.log('API Key已更改，音色注册页面已收到通知');
        }
    });
    
    // 监听语言切换事件，更新文件选择按钮文本
    window.addEventListener('localechange', () => {
        const fileInputLabel = document.getElementById('fileInputLabel');
        if (fileInputLabel && window.t) {
            fileInputLabel.textContent = window.t('voice.chooseFile');
        }
        updateFileDisplay();
    });
</script>
</body>
</html> 