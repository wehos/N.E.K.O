<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="emotion.manager">Live2D æƒ…æ„Ÿæ˜ å°„ç®¡ç†å™¨</title>
    <!-- i18next æ ¸å¿ƒåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/dist/umd/i18next.min.js" 
            onerror="console.error('[i18n] åŠ è½½ i18next å¤±è´¥');"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/dist/umd/i18nextBrowserLanguageDetector.min.js"
            onerror="console.error('[i18n] åŠ è½½ i18nextBrowserLanguageDetector å¤±è´¥');"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/dist/umd/i18nextHttpBackend.min.js"
            onerror="console.error('[i18n] åŠ è½½ i18nextHttpBackend å¤±è´¥');"></script>
    <!-- i18next åˆå§‹åŒ–è„šæœ¬ï¼ˆåŒ…å«è¯Šæ–­å·¥å…·å’Œ CDN å®¹é”™ï¼‰ -->
    <script>
        // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆåå†æ‰§è¡Œåˆå§‹åŒ–
        (function() {
            let checkCount = 0;
            const maxChecks = 50; // æœ€å¤šæ£€æŸ¥ 5 ç§’
            
            function checkDependencies() {
                checkCount++;
                
                const i18nextLoaded = typeof i18next !== 'undefined';
                const detectorLoaded = typeof i18nextBrowserLanguageDetector !== 'undefined';
                const backendLoaded = typeof i18nextHttpBackend !== 'undefined';
                
                if (i18nextLoaded && detectorLoaded && backendLoaded) {
                    console.log('[i18n] âœ… æ‰€æœ‰ä¾èµ–åº“å·²åŠ è½½');
                    // åŠ è½½åˆå§‹åŒ–è„šæœ¬
                    const script = document.createElement('script');
                    script.src = '/static/i18n-i18next.js';
                    document.head.appendChild(script);
                } else if (checkCount < maxChecks) {
                    // ç»§ç»­ç­‰å¾…
                    setTimeout(checkDependencies, 100);
                } else {
                    // è¶…æ—¶ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨ CDN
                    console.error('[i18n] âš ï¸ ä¾èµ–åº“åŠ è½½è¶…æ—¶ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨ CDN...');
                    console.log('[i18n] åŠ è½½çŠ¶æ€:', {
                        i18next: i18nextLoaded,
                        detector: detectorLoaded,
                        backend: backendLoaded
                    });
                    
                    // å¦‚æœ i18nextHttpBackend æœªåŠ è½½ï¼Œå°è¯•å¤‡ç”¨ CDN
                    if (!backendLoaded) {
                        console.log('[i18n] å°è¯•ä» unpkg CDN åŠ è½½ i18nextHttpBackend...');
                        const backupScript = document.createElement('script');
                        backupScript.src = 'https://unpkg.com/i18next-http-backend@2.4.2/dist/umd/i18nextHttpBackend.min.js';
                        backupScript.onload = function() {
                            console.log('[i18n] âœ… å¤‡ç”¨ CDN åŠ è½½æˆåŠŸ');
                            // å†æ¬¡æ£€æŸ¥å¹¶åŠ è½½åˆå§‹åŒ–è„šæœ¬
                            setTimeout(() => {
                                if (typeof i18nextHttpBackend !== 'undefined') {
                                    const script = document.createElement('script');
                                    script.src = '/static/i18n-i18next.js';
                                    document.head.appendChild(script);
                                }
                            }, 100);
                        };
                        backupScript.onerror = function() {
                            console.error('[i18n] âŒ å¤‡ç”¨ CDN ä¹ŸåŠ è½½å¤±è´¥');
                            // å³ä½¿å¤±è´¥ä¹ŸåŠ è½½åˆå§‹åŒ–è„šæœ¬ï¼Œè®©å®ƒä½¿ç”¨é™çº§æ–¹æ¡ˆ
                            const script = document.createElement('script');
                            script.src = '/static/i18n-i18next.js';
                            document.head.appendChild(script);
                        };
                        document.head.appendChild(backupScript);
                    } else {
                        // å…¶ä»–åº“æœªåŠ è½½ï¼Œç›´æ¥åŠ è½½åˆå§‹åŒ–è„šæœ¬
                        console.log('[i18n] åŠ è½½åˆå§‹åŒ–è„šæœ¬ï¼ˆä½¿ç”¨é™çº§æ–¹æ¡ˆï¼‰');
                        const script = document.createElement('script');
                        script.src = '/static/i18n-i18next.js';
                        document.head.appendChild(script);
                    }
                }
            }
            
            // å¼€å§‹æ£€æŸ¥
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkDependencies);
            } else {
                checkDependencies();
            }
            
            // å®‰å…¨ç½‘ï¼š10ç§’åå¼ºåˆ¶åŠ è½½åˆå§‹åŒ–è„šæœ¬ï¼ˆå³ä½¿ä¾èµ–æœªåŠ è½½ï¼‰
            setTimeout(function() {
                if (typeof window.setLocale === 'undefined') {
                    console.warn('[i18n] âš ï¸ 10ç§’åä»æœªåˆå§‹åŒ–ï¼Œå¼ºåˆ¶åŠ è½½åˆå§‹åŒ–è„šæœ¬');
                    const script = document.createElement('script');
                    script.src = '/static/i18n-i18next.js';
                    document.head.appendChild(script);
                }
            }, 10000);
        })();
    </script>
    <script src="/static/common_dialogs.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus {
            outline: none !important;
            box-shadow: none !important; 
        }

        body {
             font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             background-attachment: fixed;
             min-height: 100vh;
             padding: 10px;
             margin: 0;
         }

                 .container {
             max-width: 1400px;
             margin: 0 auto;
             background: white;
             border-radius: 15px;
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
             overflow: hidden;
             min-height: calc(100vh - 20px);
             display: flex;
             flex-direction: column;
         }

                 .header {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 15px;
             text-align: center;
             flex-shrink: 0;
             opacity: 0.9;
         }

                 .header h1 {
             font-size: 1.6em;
             margin-bottom: 5px;
             font-weight: 500;
         }

                 .header p {
             font-size: 0.9em;
             opacity: 0.8;
         }

                 .content {
             padding: 20px;
             flex: 1;
             overflow: hidden;
             display: flex;
             flex-direction: column;
             position: relative;
         }

        

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

                 .model-selector {
             display: flex;
             gap: 15px;
             margin-bottom: 15px;
             align-items: center;
             flex-wrap: wrap;
             flex-shrink: 0;
         }

        .model-selector select {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }

        .model-selector select:focus {
            outline: none;
            border-color: #667eea;
        }

                 .emotion-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
             gap: 12px;
             flex: 1;
             margin-top: 10px;
         }

                 .emotion-card {
             background: #f8f9fa;
             border-radius: 12px;
             padding: 12px;
             border: 2px solid #e9ecef;
             transition: all 0.3s ease;
         }

        .emotion-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

                 .emotion-card h3 {
             color: #495057;
             margin-bottom: 10px;
             font-size: 1em;
             display: flex;
             align-items: center;
             gap: 8px;
             padding: 6px 0;
             border-bottom: 1px solid #dee2e6;
         }

                 .emotion-icon {
             width: 20px;
             height: 20px;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 11px;
             font-weight: bold;
             color: white;
         }

        .emotion-icon.happy { background: #ffc107; }
        .emotion-icon.sad { background: #17a2b8; }
        .emotion-icon.angry { background: #dc3545; }
        .emotion-icon.neutral { background: #6c757d; }
        .emotion-icon.surprised { background: #fd7e14; }

                 .file-list {
             margin-top: 12px;
         }

                 .file-item {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: 4px 8px;
             background: white;
             border-radius: 6px;
             margin-bottom: 4px;
             border: 1px solid #dee2e6;
         }

        .file-item:hover {
            background: #f8f9fa;
        }

                 .file-name {
             flex: 1;
             font-size: 12px;
             color: #495057;
         }

        .file-actions {
            display: flex;
            gap: 5px;
        }

                 .btn-small {
             padding: 6px 12px;
             font-size: 12px;
             border-radius: 4px;
             min-height: 28px;
             display: inline-flex;
             align-items: center;
             justify-content: center;
         }

                 .add-file-section {
             margin-top: 8px;
             padding-top: 8px;
             border-top: 1px solid #dee2e6;
         }

                 .file-input-group {
             display: flex;
             gap: 8px;
             margin-bottom: 4px;
             align-items: center;
             min-height: 36px;
         }

        .file-input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }

        .file-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

                 .file-select {
             flex: 1;
             padding: 6px 10px;
             border: 1px solid #ced4da;
             border-radius: 6px;
             font-size: 13px;
             background: white;
             min-width: 0; /* é˜²æ­¢flexé¡¹ç›®æº¢å‡º */
         }

        .file-select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ç¡®ä¿æ·»åŠ æŒ‰é’®ä¸è¢«æŒ¤å‹ */
        .file-input-group .btn-small {
            flex-shrink: 0;
            min-width: 50px;
            white-space: nowrap;
        }

                 .toast-container {
             position: fixed;
             top: 20px;
             right: 20px;
             z-index: 1000;
             max-width: 400px;
         }

         .toast {
             padding: 12px 16px;
             border-radius: 8px;
             margin-bottom: 10px;
             font-weight: 500;
             font-size: 14px;
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
             transform: translateX(100%);
             transition: transform 0.3s ease;
             opacity: 0;
         }

         .toast.show {
             transform: translateX(0);
             opacity: 1;
         }

         .toast-success {
             background: #d4edda;
             color: #155724;
             border: 1px solid #c3e6cb;
         }

         .toast-error {
             background: #f8d7da;
             color: #721c24;
             border: 1px solid #f5c6cb;
         }

         .toast-info {
             background: #d1ecf1;
             color: #0c5460;
             border: 1px solid #bee5eb;
         }

         .toast-warning {
             background: #fff3cd;
             color: #856404;
             border: 1px solid #ffeaa7;
         }

                            .status-indicator {
             position: absolute;
             top: 70px;
             left: 20px;
             display: flex;
             align-items: center;
             gap: 8px;
             font-size: 12px;
             color: #6c757d;
             padding: 6px 10px;
             background: #f8f9fa;
             border-radius: 6px;
             border: 1px solid #e9ecef;
             z-index: 10;
             max-width: 400px;
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         }

         .status-dot {
             width: 8px;
             height: 8px;
             border-radius: 50%;
             animation: pulse 2s infinite;
         }

         .status-dot.success { background: #28a745; }
         .status-dot.error { background: #dc3545; }
         .status-dot.info { background: #17a2b8; }
         .status-dot.warning { background: #ffc107; }

         @keyframes pulse {
             0% { opacity: 1; }
             50% { opacity: 0.5; }
             100% { opacity: 1; }
         }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

                 .hidden {
             display: none;
         }

         

                 .model-info {
             background: #e9ecef;
             padding: 12px;
             border-radius: 8px;
             margin-bottom: 15px;
             flex-shrink: 0;
         }

        .model-info h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .model-info p {
            margin-bottom: 5px;
            font-size: 14px;
            color: #6c757d;
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-i18n="emotion.manager">ğŸ­ Live2D æƒ…æ„Ÿæ˜ å°„ç®¡ç†å™¨</h1>
            <p data-i18n="emotion.description">ç®¡ç†å’Œé…ç½®Live2Dè§’è‰²çš„åŠ¨ä½œä¸è¡¨æƒ…æ˜ å°„</p>
        </div>

                 <div class="content">
                          <div class="model-selector">
                 <label for="model-select" data-i18n="emotion.selectModel">é€‰æ‹©Live2Dæ¨¡å‹ï¼š</label>
                 <select id="model-select" onchange="loadModelMapping()">
                     <option value="" data-i18n="emotion.pleaseSelect">è¯·é€‰æ‹©æ¨¡å‹</option>
                 </select>
                 <button class="btn btn-success" onclick="saveMapping()" data-i18n="emotion.saveConfig">ä¿å­˜é…ç½®</button>
                 <button class="btn btn-secondary" onclick="resetMapping()" data-i18n="emotion.reset">é‡ç½®</button>
             </div>
             
             <div id="model-status-indicator" class="status-indicator hidden">
                 <span class="status-dot info"></span>
                 <span id="model-status-text" data-i18n="emotion.loading">åŠ è½½ä¸­...</span>
             </div>

            <div id="model-info" class="model-info hidden">
                <h4 data-i18n="emotion.modelInfo">æ¨¡å‹ä¿¡æ¯</h4>
                <p id="model-path"></p>
                <p id="model-status"></p>
            </div>

            <div id="emotion-grid" class="emotion-grid">
                <!-- æƒ…æ„Ÿå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            
        </div>
         </div>

     <div id="toast-container" class="toast-container"></div>

     <script>
        let currentModelConfig = {};
        let availableModels = [];
        let currentModel = '';
        let currentModelFiles = { motion_files: [], expression_files: [] };
        let emotionMappingConfig = {}; // å­˜å‚¨æƒ…ç»ªæ˜ å°„é…ç½®

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableModels();
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
            showStatus('JavaScripté”™è¯¯: ' + e.error.message, 'error');
        });

        

        // åŠ è½½å¯ç”¨çš„æ¨¡å‹åˆ—è¡¨
        async function loadAvailableModels() {
            try {
                const modelsResponse = await fetch('/api/live2d/models?simple=true');
                const modelsData = await modelsResponse.json();
                
                if (modelsData.success) {
                    availableModels = modelsData.models;
                    showStatus(`è‡ªåŠ¨è¯†åˆ«åˆ° ${availableModels.length} ä¸ªLive2Dæ¨¡å‹`, 'success');
                } else {
                    showStatus('åŠ è½½å¯ç”¨æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + modelsData.error, 'error');
                    return;
                }
                
                updateModelSelector();
            } catch (error) {
                showStatus('åŠ è½½æ¨¡å‹åˆ—è¡¨æ—¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
        function updateModelSelector() {
            const select = document.getElementById('model-select');
            select.innerHTML = `<option value="">${window.t ? window.t('live2d.pleaseSelectModel') : 'è¯·é€‰æ‹©æ¨¡å‹'}</option>`;
            
            availableModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                select.appendChild(option);
            });
        }

        async function loadModelMapping() {
             const modelSelect = document.getElementById('model-select');
             const selectedModel = modelSelect.value;
             
             if (!selectedModel) {
                 showStatus(window.t ? window.t('emotion.pleaseSelectModel') : 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹', 'error');
                 return;
             }

             try {
                 const statusIndicator = document.getElementById('model-status-indicator');
                 const statusText = document.getElementById('model-status-text');
                 const statusDot = statusIndicator.querySelector('.status-dot');
                 
                 statusIndicator.classList.remove('hidden');
                 statusText.textContent = window.t ? window.t('emotion.loadingConfig') : 'æ­£åœ¨åŠ è½½é…ç½®å’Œæ¨¡å‹æ–‡ä»¶...';
                 statusDot.className = 'status-dot info';
                 
                 const [configResponse, filesResponse, emotionMappingResponse] = await Promise.all([
                     fetch(`/api/live2d/model_config/${selectedModel}`),
                     fetch(`/api/live2d/model_files/${selectedModel}`),
                     fetch(`/api/live2d/emotion_mapping/${selectedModel}`)
                 ]);
                 
                 const configData = await configResponse.json();
                 const filesData = await filesResponse.json();
                 const emotionMappingData = await emotionMappingResponse.json();
                 
                 if (configData.success) {
                     currentModelConfig = configData.config;
                     currentModel = selectedModel;
                     
                     if (filesData.success) {
                         currentModelFiles = {
                             motion_files: filesData.motion_files,
                             expression_files: filesData.expression_files
                         };
                         
                         statusText.textContent = window.t ? window.t('emotion.loaded', {motionCount: filesData.motion_files.length, expressionCount: filesData.expression_files.length}) : `å·²åŠ è½½ï¼Œå‘ç° ${filesData.motion_files.length} ä¸ªåŠ¨ä½œæ–‡ä»¶å’Œ ${filesData.expression_files.length} ä¸ªè¡¨æƒ…æ–‡ä»¶`;
                         statusDot.className = 'status-dot success';
                         
                         setTimeout(() => {
                             statusIndicator.classList.add('hidden');
                         }, 3000);
                         
                     } else {
                         currentModelFiles = { motion_files: [], expression_files: [] };
                         statusText.textContent = window.t ? window.t('emotion.configLoaded') : 'é…ç½®åŠ è½½æˆåŠŸï¼Œä½†æ— æ³•è·å–æ¨¡å‹æ–‡ä»¶';
                         statusDot.className = 'status-dot warning';
                         
                         setTimeout(() => {
                             statusIndicator.classList.add('hidden');
                         }, 3000);
                     }

                    if (emotionMappingData.success) {
                        emotionMappingConfig[currentModel] = emotionMappingData.config || { motions: {}, expressions: {} };
                    } else {
                        emotionMappingConfig[currentModel] = { motions: {}, expressions: {} };
                        showStatus(window.t ? window.t('emotion.loadEmotionFailed', {error: emotionMappingData.error}) : 'åŠ è½½æƒ…ç»ªæ˜ å°„é…ç½®å¤±è´¥: ' + emotionMappingData.error, 'error');
                    }
                     
                     // è‡ªåŠ¨ä¸ºæ²¡æœ‰æ˜ å°„çš„æ¨¡å‹æ·»åŠ æ˜ å°„
                     autoAddModelMapping(selectedModel);
                     
                     renderEmotionGrid();
                     showModelInfo();
                 } else {
                     statusText.textContent = window.t ? window.t('emotion.loadConfigFailed', {error: configData.error || 'æœªçŸ¥é”™è¯¯'}) : 'åŠ è½½é…ç½®å¤±è´¥: ' + (configData.error || 'æœªçŸ¥é”™è¯¯');
                     statusDot.className = 'status-dot error';
                     
                     setTimeout(() => {
                         statusIndicator.classList.add('hidden');
                     }, 3000);
                 }
             } catch (error) {
                 const statusIndicator = document.getElementById('model-status-indicator');
                 const statusText = document.getElementById('model-status-text');
                 const statusDot = statusIndicator.querySelector('.status-dot');
                 
                 statusIndicator.classList.remove('hidden');
                 statusText.textContent = window.t ? window.t('emotion.loadConfigError', {error: error.message}) : 'åŠ è½½é…ç½®æ—¶å‡ºé”™: ' + error.message;
                 statusDot.className = 'status-dot error';
                 
                 setTimeout(() => {
                     statusIndicator.classList.add('hidden');
                 }, 3000);
             }
         }

        // æ¸²æŸ“æƒ…æ„Ÿç½‘æ ¼
        function renderEmotionGrid() {
            const grid = document.getElementById('emotion-grid');
            grid.innerHTML = '';

            const emotions = ['happy', 'sad', 'angry', 'neutral', 'surprised', 'Idle'];
            const emotionNames = {
                'happy': 'å¼€å¿ƒ',
                'sad': 'æ‚²ä¼¤', 
                'angry': 'æ„¤æ€’',
                'neutral': 'ä¸­æ€§',
                'surprised': 'æƒŠè®¶',
                'Idle': 'å¾…æœº'
            };

            emotions.forEach(emotion => {
                const card = createEmotionCard(emotion, emotionNames[emotion]);
                grid.appendChild(card);
            });
        }

        // è‡ªåŠ¨ä¸ºæ²¡æœ‰æ˜ å°„çš„æ¨¡å‹æ·»åŠ æ˜ å°„
        function autoAddModelMapping(modelName) {
            // å¦‚æœè¯¥æ¨¡å‹åœ¨æƒ…ç»ªæ˜ å°„é…ç½®ä¸­ä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨æ·»åŠ 
            if (!emotionMappingConfig[modelName]) {
                emotionMappingConfig[modelName] = {
                    motions: {},
                    expressions: {}
                };
                showStatus(window.t ? window.t('emotion.autoCreatedMapping', {model: modelName}) : `å·²ä¸ºæ¨¡å‹ ${modelName} è‡ªåŠ¨åˆ›å»ºæƒ…ç»ªæ˜ å°„é…ç½®`, 'success');
            }
        }

        // åˆ›å»ºæƒ…æ„Ÿå¡ç‰‡
        function createEmotionCard(emotion, emotionName) {
            const card = document.createElement('div');
            card.className = 'emotion-card';
            card.id = `emotion-${emotion}`;

            // ä»æƒ…ç»ªæ˜ å°„é…ç½®ä¸­è·å–æ–‡ä»¶åˆ—è¡¨
            const modelMapping = emotionMappingConfig[currentModel] || { motions: {}, expressions: {} };
            const motions = modelMapping.motions[emotion] || [];
            const expressions = modelMapping.expressions[emotion] || [];

            // è·å–å¯ç”¨çš„æ–‡ä»¶åˆ—è¡¨
            const availableMotions = currentModelFiles.motion_files || [];
            const availableExpressions = currentModelFiles.expression_files || [];
            
            // è¿‡æ»¤æ‰å·²æ·»åŠ çš„æ–‡ä»¶
            const unusedMotions = availableMotions.filter(file => !motions.includes(file));
            const unusedExpressions = availableExpressions.filter(file => !expressions.includes(file));

            card.innerHTML = `
                <h3>
                    <span class="emotion-icon ${emotion}">${emotionName.charAt(0)}</span>
                    ${emotionName}
                </h3>
                
                <div class="file-list">
                    <h4>${window.t ? window.t('emotion.motionFiles', {count: motions.length}) : `åŠ¨ä½œæ–‡ä»¶ (${motions.length})`}</h4>
                    <div id="motions-${emotion}">
                        ${motions.map(file => createFileItem(file, emotion, 'motions')).join('')}
                    </div>
                    <div class="add-file-section">
                        <div class="file-input-group">
                            <select id="motions-select-${emotion}" class="file-select">
                                <option value="">${window.t ? window.t('emotion.selectMotionFile') : 'é€‰æ‹©åŠ¨ä½œæ–‡ä»¶'}</option>
                                ${unusedMotions.map(file => `<option value="${file}">${file}</option>`).join('')}
                            </select>
                            <button class="btn btn-small btn-primary" onclick="addFileFromSelect('${emotion}', 'motions')" ${unusedMotions.length === 0 ? 'disabled' : ''} type="button">${window.t ? window.t('emotion.add') : 'æ·»åŠ '}</button>
                        </div>
                    </div>
                </div>

                <div class="file-list">
                    <h4>${window.t ? window.t('emotion.expressionFiles', {count: expressions.length}) : `è¡¨æƒ…æ–‡ä»¶ (${expressions.length})`}</h4>
                    <div id="expressions-${emotion}">
                        ${expressions.map(file => createFileItem(file, emotion, 'expressions')).join('')}
                    </div>
                    <div class="add-file-section">
                        <div class="file-input-group">
                            <select id="expressions-select-${emotion}" class="file-select">
                                <option value="">${window.t ? window.t('emotion.selectExpressionFile') : 'é€‰æ‹©è¡¨æƒ…æ–‡ä»¶'}</option>
                                ${unusedExpressions.map(file => `<option value="${file}">${file}</option>`).join('')}
                            </select>
                            <button class="btn btn-small btn-primary" onclick="addFileFromSelect('${emotion}', 'expressions')" ${unusedExpressions.length === 0 ? 'disabled' : ''} type="button">${window.t ? window.t('emotion.add') : 'æ·»åŠ '}</button>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        // åˆ›å»ºæ–‡ä»¶é¡¹
        function createFileItem(fileName, emotion, type) {
            return `
                <div class="file-item">
                    <span class="file-name">${fileName}</span>
                    <div class="file-actions">
                        <button class="btn btn-small btn-danger" onclick="removeFile('${emotion}', '${type}', '${fileName}')">${window.t ? window.t('emotion.delete') : 'åˆ é™¤'}</button>
                    </div>
                </div>
            `;
        }

        // ä»ä¸‹æ‹‰æ¡†æ·»åŠ æ–‡ä»¶
        function addFileFromSelect(emotion, type) {
            const select = document.getElementById(`${type}-select-${emotion}`);
            const fileName = select.value;
            
            if (!fileName) {
                showStatus(window.t ? window.t('emotion.pleaseSelectFile') : 'è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                return;
            }

            // ç¡®ä¿å½“å‰æ¨¡å‹åœ¨æƒ…ç»ªæ˜ å°„é…ç½®ä¸­å­˜åœ¨
            if (!emotionMappingConfig[currentModel]) {
                emotionMappingConfig[currentModel] = { motions: {}, expressions: {} };
            }

            if (type === 'motions') {
                if (!emotionMappingConfig[currentModel].motions[emotion]) {
                    emotionMappingConfig[currentModel].motions[emotion] = [];
                }
                emotionMappingConfig[currentModel].motions[emotion].push(fileName);
            } else {
                if (!emotionMappingConfig[currentModel].expressions[emotion]) {
                    emotionMappingConfig[currentModel].expressions[emotion] = [];
                }
                emotionMappingConfig[currentModel].expressions[emotion].push(fileName);
            }

            select.value = '';
            renderEmotionGrid();
            const addedMsg = type === 'motions' 
                ? (window.t ? window.t('emotion.addedMotionFile', {file: fileName}) : `å·²æ·»åŠ åŠ¨ä½œæ–‡ä»¶: ${fileName}`)
                : (window.t ? window.t('emotion.addedExpressionFile', {file: fileName}) : `å·²æ·»åŠ è¡¨æƒ…æ–‡ä»¶: ${fileName}`);
            showStatus(addedMsg, 'success');
        }

        // åˆ é™¤æ–‡ä»¶
        function removeFile(emotion, type, fileName) {
            const modelMapping = emotionMappingConfig[currentModel];
            if (!modelMapping) return;

            if (type === 'motions') {
                const motions = modelMapping.motions[emotion];
                if (motions) {
                    const index = motions.indexOf(fileName);
                    if (index > -1) {
                        motions.splice(index, 1);
                    }
                }
            } else {
                const expressions = modelMapping.expressions[emotion];
                if (expressions) {
                    const index = expressions.indexOf(fileName);
                    if (index > -1) {
                        expressions.splice(index, 1);
                    }
                }
            }
            renderEmotionGrid();
            const removedMsg = type === 'motions'
                ? (window.t ? window.t('emotion.removedMotionFile', {file: fileName}) : `å·²åˆ é™¤åŠ¨ä½œæ–‡ä»¶: ${fileName}`)
                : (window.t ? window.t('emotion.removedExpressionFile', {file: fileName}) : `å·²åˆ é™¤è¡¨æƒ…æ–‡ä»¶: ${fileName}`);
            showStatus(removedMsg, 'success');
        }

        // ä¿å­˜æ˜ å°„é…ç½®
        async function saveMapping() {
            if (!currentModel) {
                showStatus(window.t ? window.t('emotion.pleaseSelectModel') : 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹', 'error');
                return;
            }

            try {
                showStatus(window.t ? window.t('emotion.savingConfig') : 'æ­£åœ¨ä¿å­˜é…ç½®...', 'info');
                
                // ä¿å­˜æƒ…ç»ªæ˜ å°„é…ç½®
                const emotionResponse = await fetch(`/api/live2d/emotion_mapping/${currentModel}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emotionMappingConfig[currentModel])
                });

                const emotionData = await emotionResponse.json();
                
                if (emotionData.success) {
                    showStatus(window.t ? window.t('emotion.configSaved') : 'é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    showStatus(window.t ? window.t('emotion.saveConfigFailed', {error: emotionData.error}) : 'ä¿å­˜é…ç½®å¤±è´¥: ' + emotionData.error, 'error');
                }
            } catch (error) {
                showStatus(window.t ? window.t('emotion.saveConfigError', {error: error.message}) : 'ä¿å­˜é…ç½®æ—¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        // é‡ç½®æ˜ å°„
        async function resetMapping() {
            const confirmMsg = window.t ? window.t('emotion.confirmReset') : 'ç¡®å®šè¦é‡ç½®å½“å‰é…ç½®å—ï¼Ÿè¿™å°†æ¸…ç©ºæ‰€æœ‰åŠ¨ä½œå’Œè¡¨æƒ…æ–‡ä»¶ã€‚';
            const confirmTitle = window.t ? window.t('emotion.resetConfig') : 'é‡ç½®é…ç½®';
            if (await showConfirm(confirmMsg, confirmTitle, {danger: true})) {
                if (!emotionMappingConfig[currentModel]) {
                    emotionMappingConfig[currentModel] = { motions: {}, expressions: {} };
                }
                emotionMappingConfig[currentModel].motions = { "Idle": [] };
                emotionMappingConfig[currentModel].expressions = {};
                renderEmotionGrid();
                showStatus(window.t ? window.t('emotion.configReset') : 'é…ç½®å·²é‡ç½®', 'success');
            }
        }

                 // æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
         function showModelInfo() {
             const info = document.getElementById('model-info');
             const path = document.getElementById('model-path');
             const status = document.getElementById('model-status');
             
             info.classList.remove('hidden');
             path.textContent = window.t ? window.t('emotion.model', {model: currentModel}) : `æ¨¡å‹: ${currentModel}`;
             
             // æ˜¾ç¤ºæ¨¡å‹æ–‡ä»¶çš„æ€»æ•°é‡ï¼Œè€Œä¸æ˜¯å·²é…ç½®çš„æ•°é‡
             const totalMotionFiles = currentModelFiles.motion_files.length;
             const totalExpressionFiles = currentModelFiles.expression_files.length;
             status.textContent = window.t ? window.t('emotion.motionExpressionCount', {motionCount: totalMotionFiles, expressionCount: totalExpressionFiles}) : `åŠ¨ä½œæ–‡ä»¶: ${totalMotionFiles} | è¡¨æƒ…æ–‡ä»¶: ${totalExpressionFiles}`;
         }
         
                 // æ˜¾ç¤ºtoasté€šçŸ¥
         function showStatus(message, type) {
             const toastContainer = document.getElementById('toast-container');
             const toast = document.createElement('div');
             toast.className = `toast toast-${type}`;
             toast.textContent = message;
             
             toastContainer.appendChild(toast);
             
             // è§¦å‘åŠ¨ç”»
             setTimeout(() => {
                 toast.classList.add('show');
             }, 10);
             
             // è‡ªåŠ¨ç§»é™¤
             setTimeout(() => {
                 toast.classList.remove('show');
                 setTimeout(() => {
                     if (toast.parentNode) {
                         toast.parentNode.removeChild(toast);
                     }
                 }, 300);
             }, 3000);
         }

                   // æ‰“å¼€Live2DåŠ¨ä½œé¢„è§ˆå™¨
          function openPreview() {
              // åˆ›å»ºæ¨¡æ€æ¡†
              const modal = document.createElement('div');
              modal.id = 'preview-modal';
              modal.style.cssText = `
                  position: fixed;
                  top: 0;
                  left: 0;
                  width: 100%;
                  height: 100%;
                  background: rgba(0, 0, 0, 0.8);
                  z-index: 9999;
                  display: flex;
                  justify-content: center;
                  align-items: center;
                  opacity: 0;
                  transition: opacity 0.3s ease;
              `;
              
              // åˆ›å»ºé¢„è§ˆå®¹å™¨
              const previewContainer = document.createElement('div');
              previewContainer.style.cssText = `
                  background: white;
                  border-radius: 15px;
                  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                  width: 95%;
                  height: 95%;
                  max-width: 1400px;
                  max-height: 900px;
                  position: relative;
                  overflow: hidden;
                  transform: scale(0.9);
                  transition: transform 0.3s ease;
              `;
              
              // åˆ›å»ºæç¤ºä¿¡æ¯
              const tipElement = document.createElement('div');
              tipElement.innerHTML = window.t ? window.t('emotion.clickToClosePreview') : 'ğŸ’¡ ç‚¹å‡»ç©ºç™½å¤„å…³é—­é¢„è§ˆ';
              tipElement.style.cssText = `
                  position: absolute;
                  top: 15px;
                  left: 50%;
                  transform: translateX(-50%);
                  background: rgba(0, 0, 0, 0.7);
                  color: white;
                  padding: 8px 16px;
                  border-radius: 20px;
                  font-size: 14px;
                  font-weight: 500;
                  z-index: 10000;
                  opacity: 0.9;
                  transition: opacity 0.3s ease;
              `;
              
              // åˆ›å»ºiframe
              const iframe = document.createElement('iframe');
              iframe.src = '/live2d_preview';
              iframe.style.cssText = `
                  width: 100%;
                  height: 100%;
                  border: none;
                  border-radius: 15px;
              `;
              
              // ç»„è£…æ¨¡æ€æ¡†
              previewContainer.appendChild(tipElement);
              previewContainer.appendChild(iframe);
              modal.appendChild(previewContainer);
              document.body.appendChild(modal);
              
              // æ˜¾ç¤ºåŠ¨ç”»
              setTimeout(() => {
                  modal.style.opacity = '1';
                  previewContainer.style.transform = 'scale(1)';
              }, 10);
              
              // 3ç§’åéšè—æç¤º
              setTimeout(() => {
                  tipElement.style.opacity = '0';
                  setTimeout(() => {
                      if (tipElement.parentNode) {
                          tipElement.parentNode.removeChild(tipElement);
                      }
                  }, 300);
              }, 3000);
              
              // å…³é—­åŠŸèƒ½
              function closeModal() {
                  modal.style.opacity = '0';
                  previewContainer.style.transform = 'scale(0.9)';
                  setTimeout(() => {
                      if (modal.parentNode) {
                          modal.parentNode.removeChild(modal);
                      }
                  }, 300);
              }
              
              modal.onclick = (e) => {
                  if (e.target === modal) {
                      closeModal();
                  }
              };
              
              // ESCé”®å…³é—­
              const escHandler = (e) => {
                  if (e.key === 'Escape') {
                      closeModal();
                      document.removeEventListener('keydown', escHandler);
                  }
              };
              document.addEventListener('keydown', escHandler);
          }
    </script>
</body>
</html> 